<!doctype html>
<html lang="en">
<head>
<link rel="stylesheet" href="/static/base.css">
<script defer src="/static/nav.js"></script> 
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Credit System — Apply</title>
</head>
<body>
<header class="site-header">
  <div class="navbar">
    <a class="brand" href="/">Credit System</a>
    <nav class="navlinks" id="main-nav">
      <a href="/" data-nav="home">Home</a>
      <a href="/policy" data-nav="policy" class="nav-soft">Manage Policies</a>
      <a href="/apply" data-nav="apply" class="nav-cta">Apply for Credit</a>
      <a href="/model" data-nav="model" class="nav-soft">Model</a>
    </nav>
    <button class="nav-toggle" aria-label="Open menu" aria-expanded="false">☰</button>
  </div>
</header>


<main>
  <section class="card">
    <h2 style="margin:0 0 8px">Credit application</h2>
    <p class="muted" style="margin:0 0 12px">Fill the form and submit to evaluate with the active model & policy.</p>
    <form id="frm" class="grid two">
      <div>
        <label>Full name</label>
        <input name="name" placeholder="Jane Doe" required/>
      </div>
      <div>
        <label>Age</label>
        <input name="age" type="number" min="18" max="120" step="1" placeholder="30" required/>
      </div>
      <div>
        <label>Monthly income</label>
        <input name="income" type="number" min="0" step="0.01" placeholder="2500" required/>
      </div>
      <div>
        <label>Country</label>
        <select name="country">
          <option value="">(select)</option>
          <option>IE</option><option>BR</option><option>PT</option>
          <option>ES</option><option>FR</option><option>DE</option><option>US</option>
        </select>
      </div>
      <div style="grid-column:1/-1;display:flex;gap:10px;margin-top:6px">
        <button type="submit" class="btn-acc">Submit application</button>
        <button type="button" id="btn_sample" class="btn">Fill sample</button>
        <button type="reset" class="btn">Clear</button>
      </div>
    </form>
  </section>

  <section class="card" id="result" style="display:none">
    <h3 style="margin:0 0 8px">Decision</h3>
    <table>
      <tr><th style="width:160px">Status</th><td id="r_status"></td></tr>
      <tr><th>Probability (approve)</th><td id="r_prob"></td></tr>
      <tr><th>Probability (default)</th><td id="r_pdef"></td></tr>
      <tr><th>Assigned APR</th><td id="r_apr"></td></tr>
      <tr><th>Credit limit</th><td id="r_limit"></td></tr>
      <tr><th>Policy / Model</th><td id="r_cfg"></td></tr>
      <tr><th>Reason</th><td id="r_reason" class="muted"></td></tr>
    </table>
  </section>
</main>

<script>
const $=s=>document.querySelector(s);

async function checkService(){
  try{
    const hz = await fetch("/healthz").then(r=>r.json());
    $("#srv").textContent = hz.ok ? "Service OK" : "Service down";
    $("#srv").className = "pill "+(hz.ok?"ok":"err");
  }catch{ $("#srv").textContent="Service error"; $("#srv").className="pill err"; }
}

$("#btn_sample").addEventListener("click", ()=>{
  const f = $("#frm");
  f.name.value = "Jane Doe";
  f.age.value = 28;
  f.income.value = 3000;
  f.country.value = "IE";
});

$("#frm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const form = e.target;
  const payload = {
    name: form.name.value.trim(),
    age: Number(form.age.value),
    income: Number(form.income.value),
    country: form.country.value || null
  };
  try{
    const res = await fetch("/api/apply", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      const msg = await res.text();
      throw new Error(msg || "Request failed");
    }
    const data = await res.json();
    // show result
    $("#result").style.display = "";
    $("#r_status").innerHTML = data.status === "Approved"
      ? `<span class="pill ok">Approved</span>` : `<span class="pill err">Denied</span>`;
    $("#r_prob").textContent = data.prob_approve != null ? Number(data.prob_approve).toFixed(4) : "—";
    $("#r_pdef").textContent = data.prob_default != null ? Number(data.prob_default).toFixed(4) : "—";
    $("#r_apr").textContent = data.apr != null ? (Number(data.apr)*100).toFixed(2)+" %" : "—";
    $("#r_limit").textContent = data.limit_amount != null ? Number(data.limit_amount).toFixed(0) : "—";
    $("#r_cfg").textContent = `${data.policy || "—"} / ${data.model || "—"}`;
    $("#r_reason").textContent = data.decision_reason || "OK";
  }catch(err){
    alert("Error: "+err.message);
  }
});

checkService();
</script>
</body>
</html>

